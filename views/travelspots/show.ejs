<% layout('layouts/boilerplate') %>
<link rel="stylesheet" href="/css/star_rating.css" />
<script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.6.1/maptiler-sdk.umd.min.js"></script>
<link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.6.1/maptiler-sdk.css" rel="stylesheet" />

<div class="container my-5">
  <div class="row g-4">
    <!-- Travelspot Info -->
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 rounded-3">
        <!-- Image Gallery -->
        <div class="position-relative">
          <img
            id="mainImage"
            src="<%= travelspots.images.length > 0 ? travelspots.images[0].url : '/images/default.jpg' %>"
            class="card-img-top rounded-top"
            style="max-height: 400px; object-fit: cover"
            alt="<%= travelspots.title %>"
          />
        </div>

        <!-- Thumbnails -->
        <% if (travelspots.images && travelspots.images.length > 0) { %>
        <div class="d-flex flex-wrap justify-content-center gap-2 p-3">
          <% travelspots.images.forEach((img, i) => { %>
          <img
            src="<%= img.url %>"
            class="img-thumbnail thumb <%= i === 0 ? 'border border-primary' : '' %>"
            style="cursor: pointer; height: 80px; width: 100px; object-fit: cover"
            onclick="changeImage('<%= img.url %>', this)"
          />
          <% }) %>
        </div>
        <% } %>

        <!-- Spot Details -->
        <div class="card-body">
          <h3 class="card-title mb-2"><%= travelspots.title %></h3>
          <p class="card-text text-muted"><%= travelspots.description %></p>

          <div class="mb-3">
            <span class="badge bg-danger"><i class="bi bi-geo-alt-fill"></i> <%= travelspots.location %></span>
            <span class="badge bg-primary"><i class="bi bi-person-circle"></i> <%= travelspots.author.username %></span>
            <span class="badge bg-success"><%= travelspots.price === 0 ? "Free" : `₱${travelspots.price}` %></span>
          </div>

          <!-- Buttons -->
          <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" href="/travelspots">Back</a>
            <% if(currentUser && travelspots.author.equals(currentUser._id)){ %>
            <a class="btn btn-primary" href="/travelspots/<%= travelspots._id %>/edit">Edit</a>
            <form class="d-inline" action="/travelspots/<%= travelspots._id %>?_method=DELETE" method="POST">
              <button class="btn btn-danger">Delete</button>
            </form>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Map + Reviews -->
    <div class="col-lg-6">
      <!-- Map -->
      <div class="card shadow-sm border-0 mb-4">
        <div id="map"></div>
      </div>

      <!-- Review Form -->
      <div class="card shadow-sm border-0 mb-4 rounded-3">
        <div class="card-body">
          <% if(currentUser){ %>
          <h4 class="mb-3">Leave a Review</h4>
          <form action="/travelspots/<%= travelspots._id %>/reviews" method="POST" class="needs-validation" novalidate>
            <div class="mb-3">
              <fieldset class="starability-checkmark">
                <input
                  type="radio"
                  id="no-rate"
                  class="input-no-rate"
                  name="review[rating]"
                  value="0"
                  checked
                  aria-label="No rating."
                />
                <input type="radio" id="rate1" name="review[rating]" value="1" /><label for="rate1">1 star</label>
                <input type="radio" id="rate2" name="review[rating]" value="2" /><label for="rate2">2 stars</label>
                <input type="radio" id="rate3" name="review[rating]" value="3" /><label for="rate3">3 stars</label>
                <input type="radio" id="rate4" name="review[rating]" value="4" /><label for="rate4">4 stars</label>
                <input type="radio" id="rate5" name="review[rating]" value="5" /><label for="rate5">5 stars</label>
              </fieldset>
            </div>
            <div class="mb-3">
              <label class="form-label" for="body">Your Review</label>
              <textarea name="review[body]" class="form-control" id="body" rows="3" required></textarea>
              <div class="invalid-feedback">Please write your review.</div>
            </div>
            <button class="btn btn-success">Submit</button>
          </form>
          <% } else { %>
          <p class="text-muted">You must <a href="/travelspots/login">login</a> to leave a review.</p>
          <% } %>
        </div>
      </div>

      <!-- Existing Reviews -->
      <% if(travelspots.reviews.length > 0) { %>
      <h4 class="mb-3">Reviews</h4>
      <% for(let reviews of travelspots.reviews){ %>
      <div class="card shadow-sm border-0 rounded-3 mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0 fw-bold">By <%= reviews.author.username %></h6>
            <span class="badge bg-warning text-dark">⭐ <%= reviews.rating %></span>
          </div>
          <p class="card-text"><%= reviews.body %></p>
          <% if(currentUser && reviews.author.equals(currentUser._id)){ %>
          <form action="/travelspots/<%= travelspots._id %>/reviews/<%= reviews._id %>?_method=DELETE" method="POST">
            <button class="btn btn-sm btn-outline-danger">Delete</button>
          </form>
          <% } %>
        </div>
      </div>
      <% } %> <% } else { %>
      <p class="text-muted">No reviews yet. Be the first to leave one!</p>
      <% } %>
    </div>
  </div>
</div>

<script>
  function changeImage(src, thumbEl) {
    document.getElementById("mainImage").src = src;
    document.querySelectorAll(".thumb").forEach((el) => el.classList.remove("border", "border-primary"));
    thumbEl.classList.add("border", "border-primary");
  }
</script>

<script>
  const map_key = "<%- process.env.MAP_TILER_KEY %>";
  const travelspot = <%- JSON.stringify(travelspots) %>;
</script>

<script src="/js/map_gui.js"></script>
